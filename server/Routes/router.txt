const express = require("express");
const nodemailer = require("nodemailer");
const bodyParser = require("body-parser");
const multer = require("multer");
const path = require("path");
const router = express.Router();
const cors = require("cors");

const app = express();
const port = 5000;

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(cors());

const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, "uploads/");
  },
  filename: function (req, file, cb) {
    cb(null, Date.now() + path.extname(file.originalname));
  },
});

const upload = multer({ storage: storage });

router.post("/upload-file", upload.single("cv"), (req, res) => {
  try {
    if (!req.file) {
      throw new Error("No file uploaded");
    }

    const filename = req.file.filename;
    const filePath = path.join(__dirname, "uploads", filename);

    res.status(200).send(filename);
  } catch (error) {
    console.error("Error uploading file:", error);
    res.status(500).send("Error uploading file: " + error.message);
  }
});

router.post("/submit-form", async (req, res) => {
  const { name, email, phone, career } = req.body;
  const cvFileName = req.body.cvFileName;

  const transporter = nodemailer.createTransport({
    host: "smtp.hostinger.com",
    port: 587,
    secure: false,
    auth: {
      user: "hr@autorobos.com",
      pass: "Hr@12345",
    },
    tls: {
      rejectUnauthorized: false,
    },
  });

  if (cvFileName) {
    const mailOptions = {
      from: "hr@autorobos.com",
      to: "hr@autorobos.com",
      subject: `New Career Form Submission for ${career}`,
      html: `
        <p>Name: ${name}</p>
        <p>Email: ${email}</p>
        <p>Phone: ${phone}</p>
        <p>Career: ${career}</p>
      `,
      attachments: [
        {
          filename: cvFileName,
          path: path.join(__dirname, "uploads", cvFileName),
        },
      ],
    };

    transporter.sendMail(mailOptions, (error, info) => {
      if (error) {
        console.error("Error sending email:", error);
        res.status(500).send("Error sending email: " + error.message);
      } else {
        console.log("Email sent:", info.response);
        res.status(200).send("Form submitted successfully");
      }
    });
  } else {
    console.error("cvFileName is undefined");
    res.status(400).send("cvFileName is undefined");
  }
});

module.exports = router;
